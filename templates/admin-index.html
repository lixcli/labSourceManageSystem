{% extends "base.html" %}
{% block title %}é¦–é¡µ{% endblock %}

{% block nav %}
{{ super() }}
<li class="layui-nav-item">
    <a class="" href="javascript:;">å®éªŒå®¤ç®¡ç†</a>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('lab_manage.newLab')}}">æ–°å®éªŒå®¤ç™»è®°</a></dd>
    </dl>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('lab_manage.deleteLab')}}">å®éªŒå®¤æ³¨é”€</a></dd>
    </dl>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('lab_manage.labSet')}}">å®éªŒå®¤è½¯ä»¶é…ç½®</a></dd>
    </dl>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('lab_manage.labComputer')}}">å®éªŒå®¤ç”µè„‘é…ç½®</a></dd>
    </dl>

</li>
<li class="layui-nav-item">
    <a class="" href="javascript:;">è½¯ä»¶ç®¡ç†</a>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('soft_manage.newSoftware')}}">è½¯ä»¶å…¥åº“</a></dd>
    </dl>
</li>
<li class="layui-nav-item">
    <a class="" href="javascript:;">ç”µè„‘ç®¡ç†</a>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('computer_manage.newComputer')}}">ç”µè„‘å…¥åº“</a></dd>
    </dl>
    <dl class="layui-nav-child">
        <dd><a href="{{url_for('computer_manage.removeComputer')}}">é—²ç½®ç”µè„‘</a></dd>
    </dl>
</li>
<li class="layui-nav-item">
    <a class="" href="{{url_for('demand_manage.operDemand')}}">éœ€æ±‚ç®¡ç†</a>
</li>
<li class="layui-nav-item">
    <a class="" href="{{url_for('user_manage.manage_user')}}">ç”¨æˆ·ç®¡ç†</a>
</li>
<!-- TODO ç®¡ç†å‘˜è½¯ä»¶éœ€æ±‚è§†å›¾ -->
{#
<li class="layui-nav-item">
    <a class="" href="javascript:;">è½¯ä»¶è®¾ç½®</a>
    <!-- TODO è½¯ä»¶å¢åˆ æ”¹ç»Ÿ -->
</li>
<li class="layui-nav-item">
    <a href="javascript:;">éœ€æ±‚æŸ¥çœ‹</a>
    <dl class="lay-ui-child">
        <dd><a href="{{url_for('demandOpen')}}">æœªè§£å†³éœ€æ±‚</a></dd>
        <dd><a href="{{url_for('demandClosed')}}">å·²è§£å†³éœ€æ±‚</a></dd>
    </dl>
</li>
#}
{% endblock %}
{% block body %}

<!-- è®¾ç½®æŠ˜å è¡¨æ ¼ -->
<div class="layui-collapse">
    <div class="layui-colla-item">
      <h2 class="layui-colla-title"><i class="layui-icon">&#xe653;</i> è½¯ä»¶Ã—<span id="software"></span></h2>
      <div class="layui-colla-content layui-show">
        <table class="layui-hide" id="sTest" lay-filter="sTest"></table>
      </div>
    </div>
    <div class="layui-colla-item">
      <h2 class="layui-colla-title"><i class="layui-icon">&#xe68e;</i>  å®éªŒå®¤Ã—<span id="lab"></span></h2>
      <div class="layui-colla-content layui-show">
        <table class="layui-hide" id="lTest" lay-filter="lTest"></table>
      </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script type="text/html" id="toolbar">
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm" lay-event="getCheckData">åˆ é™¤é€‰ä¸­è¡Œæ•°æ®</button>
      <button class ="layui-btn layui-btn-primary layui-btn-sm" data-type ="reload" lay-event="search"><i class="layui-icon">&#xe615;</i></button>
      <button class ="layui-btn layui-btn layui-btn-sm" data-type ="reload" lay-event="reload"><i class="layui-icon" >&#xe669;</i></button>
      
    </div>
</script>
<script type="text/html" id="bar">
<!-- <a class="layui-btn layui-btn-xs" lay-event="edit">ç¼–è¾‘</a> -->
<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</a>
<a class="layui-btn layui-btn layui-btn-xs" lay-event="info">è¯¦æƒ…</a>
</script>
            
<script>
    layui.use(['table','layer'], function(){
      var table = layui.table;
      var layer = layui.layer
      table.render({
        elem: '#sTest'
        ,skin: 'nob'
        ,size: 'lg'
        ,url:'{{ url_for("soft_manage.check_softwares") }}'
        ,toolbar: '#toolbar' //å¼€å¯å¤´éƒ¨å·¥å…·æ ï¼Œå¹¶ä¸ºå…¶ç»‘å®šå·¦ä¾§æ¨¡æ¿
        ,title: 'è½¯ä»¶æ•°æ®è¡¨'
        
        ,cols: [[
          {type: 'checkbox', fixed: 'left'}
          ,{field:'id', title:'è½¯ä»¶id', width:150, fixed: 'left', unresize: true, sort: true}
          ,{field:'sName', title:'è½¯ä»¶å', width:120}
          ,{field:'version', title:'ç‰ˆæœ¬', width:120}
          ,{field:'sysType', title:'ç³»ç»Ÿè¦æ±‚', width:150}
          ,{field:'aId', title:'å…¥åº“æ“ä½œå‘˜', width:180}
          ,{fixed: 'right', title:'æ“ä½œ', toolbar: '#bar', width:150}
        ]]
        ,align:"center"
        ,page: true
        ,limit: 7
        ,response: {
            statusCode: 0 //é‡æ–°è§„å®šæˆåŠŸçš„çŠ¶æ€ç ä¸º 200ï¼Œtable ç»„ä»¶é»˜è®¤ä¸º 0
          }
        ,parseData: function(res){ //res å³ä¸ºåŸå§‹è¿”å›çš„æ•°æ®
            $('#software').text(String(res.count));
            return {
              "code": res.code, //è§£ææ¥å£çŠ¶æ€
              "msg": res.msg, //è§£ææç¤ºæ–‡æœ¬
              "count": res.count, //è§£ææ•°æ®é•¿åº¦
              "data": res.data //è§£ææ•°æ®åˆ—è¡¨
            };
          }

      });
      
      //å¤´å·¥å…·æ äº‹ä»¶
      table.on('toolbar(sTest)', function(obj){
        var checkStatus = table.checkStatus(obj.config.id);
        switch(obj.event){
          case 'getCheckData':
            var data = checkStatus.data;
            var _list=[];
            layer.confirm(
                'æ­¤æ“ä½œå°†åˆ é™¤æ•°æ®åº“ä¸­å¯¹åº”çš„æ•°æ®'
                ,{
                    time:20000
                },
                (index)=>{
                    var _list= [];
                    for(var i=0;i<data.length;i++)
                    {
                        _list.push($.trim(data[i].id));
                    }

                    var data_id = {
                        ids:JSON.stringify(_list)
                    };
                    $.ajax({
                        type:'post',
                        async:true,
                        url:"{{url_for('soft_manage.delete_check_softwares')}}",
                        data:data_id,
                        success:function (result) {
                            table.reload('sTest');
                            layer.msg('å·²åˆ é™¤'
                            ,{
                                time:1000
                            });
  
                        },
                        error: function(){
                            layer.msg('åˆ é™¤å¤±è´¥'
                            ,{
                                time:1000
                            })}
                        
                    });
                    layer.close();
                    }

            )
    
          break;
          case 'search':
            layer.prompt({
              formType: 2,
              value: '',
              title: 'ğŸ˜€æœ!' 
            }, function(value, index, elem){
              //alert(value); //å¾—åˆ°value
              table.reload('sTest', { //è¡¨æ ¼çš„id
                where: {
                    'main_search':value
                }
            });
              layer.close(index);
            });

          break;

          case 'reload':
            table.reload('sTest');
          break;
                    //åé¢å†åŠ åŠŸèƒ½
        };
      });
      
      //ç›‘å¬è¡Œå·¥å…·äº‹ä»¶
      table.on('tool(sTest)', function(obj){
        var data = obj.data;
        //console.log(obj)
    

        if(obj.event === 'del'){
          layer.confirm('è¯¥æ•°æ®å°†ä»æ•°æ®åº“åˆ é™¤', function(index){
            var _list=[];
            _list.push($.trim(data.id));
            obj.del();
            var data_id = {
                ids:JSON.stringify(_list)
            };
            $.ajax({
                type:'post',
                async:true,
                url:"{{url_for('soft_manage.delete_check_softwares')}}",
                data:data_id,
                success:function (result) {
                    layer.msg('å·²åˆ é™¤'
                    ,{
                        time:1000
                    });
                    
                },
                error: function(){
                    layer.msg('åˆ é™¤å¤±è´¥'
                    ,{
                        time:1000
                    });
                }
            });

            layer.close(index);
          });
        }
        else if(obj.event === 'info'){
          window.location.href="/soft_info/"+"?sId="+String(data.id)
        }

      });
    
      
      table.render({
        elem: '#lTest'
        ,url:'{{ url_for("lab_manage.check_labs") }}'
        ,toolbar: '#toolbar' //å¼€å¯å¤´éƒ¨å·¥å…·æ ï¼Œå¹¶ä¸ºå…¶ç»‘å®šå·¦ä¾§æ¨¡æ¿
        ,title: 'å®éªŒå®¤æ•°æ®è¡¨'
        ,skin: 'nob'
        ,size: 'lg'
        ,cols: [[
          {type: 'checkbox', fixed: 'left'}
          ,{field:'id', title:'å®éªŒå®¤å·', width:150, fixed: 'left', unresize: true, sort: true}
          ,{field:'lName', title:'å®éªŒå®¤å', width:120}
          ,{field:'count', title:'å®éªŒå®¤ç”µè„‘å®¹é‡', width:120}
          ,{field:'aId', title:'å…¥åº“æ“ä½œå‘˜', width:180}
          ,{fixed: 'right', title:'æ“ä½œ', toolbar: '#bar', width:150}
        ]]
        ,page: true
        ,limit: 7
        ,response: {
            statusCode: 0 //é‡æ–°è§„å®šæˆåŠŸçš„çŠ¶æ€ç ä¸º 200ï¼Œtable ç»„ä»¶é»˜è®¤ä¸º 0
          }
        ,parseData: function(res){ //res å³ä¸ºåŸå§‹è¿”å›çš„æ•°æ®
            $('#lab').text(String(res.count));
            return {
              "code": res.code, //è§£ææ¥å£çŠ¶æ€
              "msg": res.msg, //è§£ææç¤ºæ–‡æœ¬
              "count": res.count, //è§£ææ•°æ®é•¿åº¦
              "data": res.data //è§£ææ•°æ®åˆ—è¡¨
            };
          }

      });
      
      //å¤´å·¥å…·æ äº‹ä»¶
      table.on('toolbar(lTest)', function(obj){
        var checkStatus = table.checkStatus(obj.config.id);
        switch(obj.event){
          case 'getCheckData':
            var data = checkStatus.data;
            var _list=[];
            layer.confirm(
                'æ­¤æ“ä½œå°†åˆ é™¤æ•°æ®åº“ä¸­å¯¹åº”çš„æ•°æ®'
                ,{
                    time:20000
                },
                (index)=>{
                    var _list= [];
                    for(var i=0;i<data.length;i++)
                    {
                        _list.push($.trim(data[i].id));
                    }

                    var data_id = {
                        ids:JSON.stringify(_list)
                    };
                    $.ajax({
                        type:'post',
                        async:true,
                        url:"{{url_for('lab_manage.delete_check_labs')}}",
                        data:data_id,
                        success:function (result) {
                            table.reload('sTest');
                            layer.msg('å·²åˆ é™¤'
                            ,{
                                time:1000
                            });
  
                        },
                        error: function(){
                            layer.msg('åˆ é™¤å¤±è´¥'
                            ,{
                                time:1000
                            })}
                        
                    });
                    layer.close();
                    }

            )
    
          break;
          case 'search':
          layer.prompt({
            formType: 2,
            value: '',
            title: 'ğŸ˜€æœ!' 
          }, function(value, index, elem){
            //alert(value); //å¾—åˆ°value
            table.reload('lTest', { //è¡¨æ ¼çš„id
              where: {
                  'main_search':value
              }
          });
            layer.close(index);
          });
          break;
          case 'reload':
            table.reload('lTest');
          break;
                    //åé¢å†åŠ åŠŸèƒ½
        };
      });
      
      //ç›‘å¬è¡Œå·¥å…·äº‹ä»¶
      table.on('tool(lTest)', function(obj){
        var data = obj.data;
        //console.log(obj)
    

        if(obj.event === 'del'){
          layer.confirm('è¯¥æ•°æ®å°†ä»æ•°æ®åº“åˆ é™¤', function(index){
            var _list=[];
            _list.push($.trim(data.id));
            obj.del();
            var data_id = {
                ids:JSON.stringify(_list)
            };
            $.ajax({
                type:'post',
                async:true,
                url:"{{url_for('lab_manage.delete_check_labs')}}",
                data:data_id,
                success:function (result) {
                    layer.msg('å·²åˆ é™¤'
                    ,{
                        time:1000
                    });
                    
                },
                error: function(){
                    layer.msg('åˆ é™¤å¤±è´¥'
                    ,{
                        time:1000
                    });
                }
            });

            layer.close(index);
          });
        }
        
        else if(obj.event === 'info'){
          window.location.href="/lab_info/"+"?labId="+String(data.id)
        }
      });
    
      
    });
    </script>
{% endblock %}